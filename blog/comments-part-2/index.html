<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title></title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://www.bytekeeper.org/atom.xml">
      

      
          <link rel="stylesheet" href="https://www.bytekeeper.org/site.css">
      

      
<link rel="stylesheet" href="https://www.bytekeeper.org/custom.css">
<script defer data-domain="bytekeeper.org" src="https://plausible.bytekeeper.org/js/pls.js"></script>
<meta name="referrer" content="same-origin">

    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;www.bytekeeper.org&#x2F;">
                                <span itemprop="name">Home
                                </span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;www.bytekeeper.org&#x2F;blog&#x2F;">
                                <span itemprop="name">Blog
                                </span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">Comments for static pages? - Part 2</h1>
        <span class="muted">
    <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>3 minute read</span>
    <svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2020-01-25
</span>
    </header>
    <div itemprop="articleBody">
      <p>Looking [back]({% link _posts/2020-01-21-comments-on-jekyll.markdown %})... I need a bit of DIY GitHub API for Rust.</p>
<h2 id="still-step-2-create-a-branch-and-pr-automatically">Still step 2: Create a branch and PR automatically</h2>
<p>Thankfully, the <a href="https://developer.github.com/v3/">V3 API</a> is really simple.</p>
<p>Using our tRusty language, we can define some structs to be serialized to JSON for requests:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(Serialize)]
</span><span style="color:#b48ead;">struct </span><span>CreateRef {
</span><span>    r#</span><span style="color:#bf616a;">ref</span><span>: String, </span><span style="color:#65737e;">// The name to be used
</span><span>    </span><span style="color:#bf616a;">sha</span><span>: String,   </span><span style="color:#65737e;">// The commit SHA to point to
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">derive</span><span>(Serialize)]
</span><span style="color:#b48ead;">struct </span><span>CreateFile {
</span><span>    </span><span style="color:#bf616a;">message</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">content</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">branch</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">committer</span><span>: UserRef,
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">derive</span><span>(Serialize)]
</span><span style="color:#b48ead;">struct </span><span>UserRef {
</span><span>    </span><span style="color:#bf616a;">name</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">email</span><span>: String,
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">derive</span><span>(Serialize)]
</span><span style="color:#b48ead;">struct </span><span>CreatePR {
</span><span>    </span><span style="color:#bf616a;">title</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">head</span><span>: String,   </span><span style="color:#65737e;">// The branch to be merged
</span><span>    </span><span style="color:#bf616a;">base</span><span>: String,   </span><span style="color:#65737e;">// The target branch for the merge (ie. master)
</span><span>}
</span></code></pre>
<p>The basic steps we want to do are described by these:</p>
<ul>
<li>Create a branch, using <code>CreateRef</code>. Git uses refs for things that &quot;have&quot; commits. A branch is just that!</li>
<li>Create a file on the branch with <code>CreateFile</code>. <code>UserRef</code> will be used as committer (me in this case).</li>
<li>The last step is to create a PR with <code>CreatePR</code>  (quelle surprise), to merge the branch back.</li>
</ul>
<p>The file we want to create has to be converted to base64 to be used by <code>CreateFile</code>. The content itself should be YAML and contain this:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(Serialize)]
</span><span style="color:#b48ead;">struct </span><span>Comment {
</span><span>    </span><span style="color:#bf616a;">id</span><span>: String,
</span><span>    r#</span><span style="color:#bf616a;">ref</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">message</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">name</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">url</span><span>: String,
</span><span>    </span><span style="color:#bf616a;">date</span><span>: </span><span style="color:#b48ead;">u64</span><span>,
</span><span>}
</span></code></pre>
<p>Luckily <a href="https://serde.rs/">serde</a> comes to our rescue once again and happily creates a serializer to yaml here.
Another helpful small library provides base64 encoding. The result is this:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> file = CreateFile {
</span><span>    message: &quot;</span><span style="color:#a3be8c;">Comment</span><span>&quot;.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    content: </span><span style="color:#96b5b4;">encode</span><span>(&amp;serde_yaml::to_string(&amp;comment).</span><span style="color:#96b5b4;">unwrap</span><span>()),
</span><span>    branch: branch_name.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    committer: UserRef {
</span><span>        name: owner.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>        email: owner_email.</span><span style="color:#96b5b4;">to_string</span><span>(),
</span><span>    },
</span><span>};
</span></code></pre>
<p>The requests itself look quite similar. As an example, here's the <code>CreateFile</code> one:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">create_file</span><span>(
</span><span>    </span><span style="color:#bf616a;">client</span><span>: &amp;reqwest::blocking::Client,
</span><span>    </span><span style="color:#bf616a;">owner</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>    </span><span style="color:#bf616a;">repo</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>    </span><span style="color:#bf616a;">path</span><span>: &amp;</span><span style="color:#b48ead;">str</span><span>,
</span><span>    </span><span style="color:#bf616a;">create_file</span><span>: &amp;CreateFile,
</span><span>) -&gt; reqwest::Result&lt;reqwest::blocking::Response&gt; {
</span><span>    </span><span style="color:#b48ead;">let</span><span> url = url::Url::parse(
</span><span>        format!(
</span><span>            &quot;</span><span style="color:#a3be8c;">https://api.github.com/repos/</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">/</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">/contents/</span><span style="color:#d08770;">{}</span><span>&quot;,
</span><span>            owner, repo, path
</span><span>        )
</span><span>        .</span><span style="color:#96b5b4;">as_str</span><span>(),
</span><span>    )
</span><span>    .</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    client.</span><span style="color:#96b5b4;">put</span><span>(url).</span><span style="color:#96b5b4;">json</span><span>(create_file).</span><span style="color:#96b5b4;">send</span><span>()
</span><span>}
</span></code></pre>
<p>No, <code>reqwest</code> is not a typo! It's actually a <a href="https://github.com/seanmonstar/reqwest">popular library</a> (I don't mean the javascript one).
I don't really need non-blocking I/O here, so the <code>blocking</code> client is put to good use.</p>
<p>The whole Rust project can be found <a href="https://github.com/Bytekeeper/github_comment_rs">in my GitHub repo</a>.</p>
<p>I tried to solve this &quot;problem&quot; with some constraints: </p>
<ul>
<li>It should be inexpensive</li>
<li>It should respect the privacy of my readers</li>
<li>It should be simple enough to fix or port</li>
<li>It should not depend too much on third parties</li>
</ul>
<p>Using GitHub for the blog and for comments is very inexpensive. I use no third party commentary service, as such the privacy is protected as much as is possible here.
The HTML part is very simple and only depends on <a href="https://jekyllrb.com/">Jekyll</a>. The Rust part is also simple and fits in less than 300 lines of code of Rust.</p>
<p>Success ✓</p>
<p>If you have any comments, please leave them down below - since you are actually able to do so now!</p>

    </div>

    
        <footer>
            <hr>
            <p>
                
                
                
            </p>
            

<div id="comments">


</div>



        </footer>
    
</article>


    </body>

</html>
